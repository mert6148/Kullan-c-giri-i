name: CI — Tests & Reports

on:
  push:
    branches: [ main, project-main ]
  pull_request:
    branches: [ main, project-main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      # Default minimum coverage percentage (can be overridden in Actions workflow environment)
      COVERAGE_MIN: 80
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          python --version
          python -c "import sys; print(f'Python {sys.version}')"

      - name: Install Node.js dependencies
        run: |
          npm install --save-dev eslint eslint-plugin-html htmlhint

      - name: Install additional dependencies
        run: |
          pip install flask flask-cors

      - name: Run pytest and write JUnit + coverage (fail if coverage lower than $COVERAGE_MIN%)
        run: |
          mkdir -p artifacts
          pytest -q --junitxml=artifacts/pytest-report.xml --cov=./ --cov-report=xml:artifacts/coverage.xml --cov-report=html:artifacts/coverage-html --cov-fail-under=$COVERAGE_MIN || true

      - name: Run user login validation tests
        run: |
          mkdir -p artifacts
          python test_user_login_validation.py 2>&1 | tee artifacts/user-login-validation.log || true
          python -m pytest test_user_login_validation.py -v --junitxml=artifacts/user-login-validation-report.xml || true

      - name: Run configuration validation tests
        run: |
          mkdir -p artifacts
          python test_configuration_validation.py 2>&1 | tee artifacts/config-validation.log || true
          python -m pytest test_configuration_validation.py -v --junitxml=artifacts/config-validation-report.xml || true

      - name: Run verify_workflow and write JUnit
        run: |
          mkdir -p artifacts
          python verify_workflow.py --all --report-format junit --output artifacts/verify-report.xml || true

      - name: Run asset validation tests
        run: |
          mkdir -p artifacts
          python test_assets.py 2>&1 | tee artifacts/asset-validation.log || true
          python -m pytest test_assets.py -v --junitxml=artifacts/asset-validation-report.xml || true

      - name: Run systematic validation workflow
        run: |
          mkdir -p artifacts
          python test_validation_workflow.py 2>&1 | tee artifacts/systematic-validation.log || true
          python -m pytest test_validation_workflow.py -v --junitxml=artifacts/systematic-validation-report.xml || true

      - name: Run assets systematic tests
        run: |
          mkdir -p artifacts
          python test_assets_systematic.py 2>&1 | tee artifacts/assets-systematic.log || true
          python -m pytest test_assets_systematic.py -v --junitxml=artifacts/assets-systematic-report.xml || true

      - name: Lint HTML files
        run: |
          npx htmlhint "config/src/*.html" || true

      - name: Lint JavaScript files
        run: |
          npx eslint "config/src/*.js" --format json --output-file artifacts/eslint-report.json || true

      - name: Validate UI/ML/AI/OS configurations
        run: |
          echo "=== UI/ML/AI/OS Konfigürasyon Validasyonu ==="
          echo "Checking configuration files..."
          
          # UI dosyaları kontrolü
          if [ -f "config/src/style.css" ]; then
            echo "✓ CSS dosyası bulundu"
          fi
          
          # ML config kontrolü
          if [ -f "config/src/ml-config.js" ]; then
            echo "✓ ML config dosyası bulundu"
          fi
          
          # HTML dosyaları kontrolü
          html_count=$(find config/src -name "*.html" -type f | wc -l)
          echo "✓ $html_count HTML dosyası bulundu"
          
          # JavaScript dosyaları kontrolü
          js_count=$(find config/src -name "*.js" -type f | wc -l)
          echo "✓ $js_count JavaScript dosyası bulundu"
          
          # Assests modülü kontrolü
          if [ -f "assests/assest.py" ]; then
            echo "✓ Assests modülü bulundu"
          fi
          
          echo "=== Validasyon Tamamlandı ==="

      - name: Upload test reports & coverage
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            artifacts/*.xml
            artifacts/*.log
            artifacts/coverage.xml
            artifacts/coverage-html/**
            artifacts/eslint-report.json
